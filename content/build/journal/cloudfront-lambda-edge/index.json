{"code":"var Component=(()=>{var b=Object.create;var r=Object.defineProperty;var p=Object.getOwnPropertyDescriptor;var m=Object.getOwnPropertyNames;var u=Object.getPrototypeOf,y=Object.prototype.hasOwnProperty;var v=(n,e)=>()=>(e||n((e={exports:{}}).exports,e),e.exports),k=(n,e)=>{for(var l in e)r(n,l,{get:e[l],enumerable:!0})},c=(n,e,l,o)=>{if(e&&typeof e==\"object\"||typeof e==\"function\")for(let s of m(e))!y.call(n,s)&&s!==l&&r(n,s,{get:()=>e[s],enumerable:!(o=p(e,s))||o.enumerable});return n};var g=(n,e,l)=>(l=n!=null?b(u(n)):{},c(e||!n||!n.__esModule?r(l,\"default\",{value:n,enumerable:!0}):l,n)),f=n=>c(r({},\"__esModule\",{value:!0}),n);var t=v((B,i)=>{i.exports=_jsx_runtime});var C={};k(C,{default:()=>h,frontmatter:()=>N});var a=g(t()),N={title:\"Dynamic Origin for CloudFront with Lambda@Edge\",description:\"Support infinite* origins for your CloudFront distribution with Lambda@Edge.\",tags:[\"AWS\",\"CloudFront\",\"Serverless\"],date:\"10/10/2024\",imageSrc:\"./image.jpg\",imageAlt:\"A person in a warehouse using a forklift.\",imageCredit:\"ELEVATE\"};function d(n){let e={a:\"a\",blockquote:\"blockquote\",code:\"code\",h2:\"h2\",h3:\"h3\",p:\"p\",pre:\"pre\",span:\"span\",...n.components},{Details:l}=e;return l||w(\"Details\",!0),(0,a.jsxs)(a.Fragment,{children:[(0,a.jsxs)(e.blockquote,{children:[`\n`,(0,a.jsxs)(e.p,{children:[\"If you're in a hurry, you can jump straight to the \",(0,a.jsx)(e.a,{href:\"#the-solution\",children:\"solution\"}),\".\"]}),`\n`]}),`\n`,(0,a.jsxs)(e.p,{children:[\"Recently I had to implement a solution that's now part of the live streaming capabilities of \",(0,a.jsx)(e.a,{href:\"https://app.fanfest.io/psg\",children:\"FanFest v3\"}),\" and it involved dealing with CloudFront and it ended up being a great opportunity to learn more about its inner-working.\"]}),`\n`,(0,a.jsx)(e.p,{children:\"The setup for this task is simple: for every live show we do, we have to create 2 AWS MediaLive channels (one for mobile and another one for desktop), and each channel has its own HLS endpoint. This was being distributed via S3 in its own bucket containing the segments and manifest files - since the S3 bucket is a single origin for the CloudFront distribution, that was easy-peasy.\"}),`\n`,(0,a.jsx)(e.p,{children:\"But then we noticed the latency of the channels was too high for the experiences we wanted to deliver to our users, so we decided to use MediaPackage to fix that. This creates a problem: each MediaPackage channel has its own endpoint which requires its individual origin in CloudFront.\"}),`\n`,(0,a.jsx)(e.p,{children:\"Digging up the AWS documentation, I found out that CloudFront only supports up-to 100 origins per distribution, which is a problem for us since we don't want to constrain ourselves to a fixed number of live shows. So I had to come up with a solution that would allow us to support inifinite (rather dynamic, we didn't really have infinite money \\u{1F61B}) origins for our CloudFront distribution.\"}),`\n`,(0,a.jsxs)(e.p,{children:[\"Fortunately and thanks to all the great work from AWS team, I found this weirdly specific article on the subject: \",(0,a.jsx)(e.a,{href:\"https://aws.amazon.com/blogs/media/creating-dynamic-mediapackage-origin-mappings-using-amazon-cloudfront-and-aws-lambdaedge/\",children:\"Creating dynamic MediaPackage origin mappings using Amazon CloudFront and AWS Lambda@Edge\"}),\" so the implementation was pretty straightforward.\"]}),`\n`,(0,a.jsx)(l,{summary:\"You're telling me you'll have 100 shows!? YAGNI\",children:(0,a.jsx)(e.p,{children:\"Well, not really. But think about trying to come back to this later on and realising you have to refactor everything because you didn't think about it before. Since we're just getting started, it's better to think about it now and save ourselves some headaches later on.\"})}),`\n`,(0,a.jsxs)(e.h2,{id:\"the-solution\",children:[(0,a.jsx)(e.a,{\"aria-hidden\":\"true\",tabIndex:\"-1\",href:\"#the-solution\",children:(0,a.jsx)(e.span,{className:\"icon icon-link\"})}),\"The Solution\"]}),`\n`,(0,a.jsx)(e.p,{children:\"The solution is to use Lambda@Edge to route the requests to the desired Origin on demand.\"}),`\n`,(0,a.jsxs)(e.blockquote,{children:[`\n`,(0,a.jsx)(e.p,{children:\"Since I find myself very comfortable using the Serverless Framework, I'll be using it in this guide to deploy the routing function. But notice that you can use similar tools or AWS' console to deploy the Lambda.\"}),`\n`]}),`\n`,(0,a.jsxs)(e.h3,{id:\"step-1-create-the-lambdaedge-function\",children:[(0,a.jsx)(e.a,{\"aria-hidden\":\"true\",tabIndex:\"-1\",href:\"#step-1-create-the-lambdaedge-function\",children:(0,a.jsx)(e.span,{className:\"icon icon-link\"})}),\"Step 1: Create the Lambda@Edge function\"]}),`\n`,(0,a.jsx)(e.p,{children:\"For this, you should have defined the URL scheme you'll use to route the requests. For our case, we decided to use a scheme similar to the following:\"}),`\n`,(0,a.jsx)(e.pre,{\"data-line-numbers\":\"true\",tabIndex:\"0\",\"data-lang\":\"javascript\",style:{color:\"var(--base05)\",backgroundColor:\"var(--base00)\"},children:(0,a.jsx)(e.code,{children:(0,a.jsxs)(e.span,{className:\"codeblock-line\",\"data-line-number\":\"1\",children:[\"`\",(0,a.jsx)(e.span,{style:{color:\"var(--base0B)\"},children:\"https://\"}),\"${\",(0,a.jsx)(e.span,{style:{color:\"var(--base08)\"},children:\"distribution\"}),\"}\",(0,a.jsx)(e.span,{style:{color:\"var(--base0B)\"},children:\".cloudfront.net/\"}),\"${\",(0,a.jsx)(e.span,{style:{color:\"var(--base08)\"},children:\"show_id\"}),\"}\",(0,a.jsx)(e.span,{style:{color:\"var(--base0B)\"},children:\"/\"}),\"${\",(0,a.jsx)(e.span,{style:{color:\"var(--base08)\"},children:\"format\"}),\"}\",(0,a.jsx)(e.span,{style:{color:\"var(--base0B)\"},children:\"/\"}),\"${\",(0,a.jsx)(e.span,{style:{color:\"var(--base08)\"},children:\"filename\"}),\"}`\",`\n`]})})}),`\n`,(0,a.jsxs)(e.p,{children:[\"Where \",(0,a.jsx)(e.code,{children:\"distribution\"}),\" is the CloudFront distribution ID, \",(0,a.jsx)(e.code,{children:\"show_id\"}),\" is the ID of the show, \",(0,a.jsx)(e.code,{children:\"format\"}),\" is the format of the stream (e.g. \",(0,a.jsx)(e.code,{children:\"mobile\"}),\", \",(0,a.jsx)(e.code,{children:\"desktop\"}),\") and \",(0,a.jsx)(e.code,{children:\"filename\"}),\" is the name of the file requested.\"]}),`\n`,(0,a.jsx)(e.p,{children:\"Then we would route the request to the corresponding MediaPackage endpoint.\"}),`\n`,(0,a.jsx)(e.pre,{\"data-line-numbers\":\"true\",tabIndex:\"0\",\"data-lang\":\"javascript\",style:{color:\"var(--base05)\",backgroundColor:\"var(--base00)\"},children:(0,a.jsx)(e.code,{children:(0,a.jsxs)(e.span,{className:\"codeblock-line\",\"data-line-number\":\"1\",children:[\"`\",(0,a.jsx)(e.span,{style:{color:\"var(--base0B)\"},children:\"https://\"}),\"${\",(0,a.jsx)(e.span,{style:{color:\"var(--base08)\"},children:\"show_id\"}),\"}\",(0,a.jsx)(e.span,{style:{color:\"var(--base0B)\"},children:\".mediapackagev2.eu-west-1.amazonaws.com/out/v1/\"}),\"${\",(0,a.jsx)(e.span,{style:{color:\"var(--base08)\"},children:\"show_id\"}),\"}\",(0,a.jsx)(e.span,{style:{color:\"var(--base0B)\"},children:\"-group/\"}),\"${\",(0,a.jsx)(e.span,{style:{color:\"var(--base08)\"},children:\"format\"}),\"}\",(0,a.jsx)(e.span,{style:{color:\"var(--base0B)\"},children:\"/\"}),\"${\",(0,a.jsx)(e.span,{style:{color:\"var(--base08)\"},children:\"format\"}),\"}\",(0,a.jsx)(e.span,{style:{color:\"var(--base0B)\"},children:\"/\"}),\"${\",(0,a.jsx)(e.span,{style:{color:\"var(--base08)\"},children:\"filename\"}),\"}`\",`\n`]})})}),`\n`,(0,a.jsxs)(e.blockquote,{children:[`\n`,(0,a.jsx)(e.p,{children:\"Note that the params that you'll use to route the request can be anything you want, as long as you can parse them in the Lambda function and route the request accordingly.\"}),`\n`]}),`\n`,(0,a.jsx)(e.p,{children:\"Now that we have the URL scheme defined, we can create the Lambda function that will route the requests:\"}),`\n`,(0,a.jsx)(e.pre,{\"data-line-numbers\":\"true\",tabIndex:\"0\",\"data-lang\":\"javascript\",style:{color:\"var(--base05)\",backgroundColor:\"var(--base00)\"},children:(0,a.jsxs)(e.code,{children:[(0,a.jsxs)(e.span,{className:\"codeblock-line\",\"data-line-number\":\"1\",children:[(0,a.jsx)(e.span,{style:{color:\"var(--base0D)\"},children:\"function\"}),\" \",(0,a.jsx)(e.span,{style:{color:\"var(--base0D)\"},children:\"parseRequestParams\"}),\"(\",(0,a.jsx)(e.span,{style:{color:\"var(--base08)\"},children:\"requestUrl\"}),\") {\",`\n`]}),(0,a.jsxs)(e.span,{className:\"codeblock-line\",\"data-line-number\":\"2\",children:[\"  \",(0,a.jsx)(e.span,{style:{color:\"var(--base03)\"},children:\"// Target URI: /${show_id}/${format}/${filename}\"}),`\n`]}),(0,a.jsxs)(e.span,{className:\"codeblock-line\",\"data-line-number\":\"3\",children:[\"  \",(0,a.jsx)(e.span,{style:{color:\"var(--base0A)\"},children:\"const\"}),\" \",(0,a.jsx)(e.span,{style:{color:\"var(--base08)\"},children:\"regex\"}),\" \",(0,a.jsx)(e.span,{style:{color:\"var(--base0E)\"},children:\"=\"}),(0,a.jsx)(e.span,{style:{color:\"var(--base0C)\"},children:\" \"}),\"/\",(0,a.jsx)(e.span,{style:{color:\"var(--base0C)\"},children:\"\\\\/\"}),\"([\",(0,a.jsx)(e.span,{style:{color:\"var(--base0E)\"},children:\"^\"}),(0,a.jsx)(e.span,{style:{color:\"var(--base0C)\"},children:\"\\\\/\"}),\"]\",(0,a.jsx)(e.span,{style:{color:\"var(--base0E)\"},children:\"+\"}),\")\",(0,a.jsx)(e.span,{style:{color:\"var(--base0C)\"},children:\"\\\\/\"}),\"([\",(0,a.jsx)(e.span,{style:{color:\"var(--base0E)\"},children:\"^\"}),(0,a.jsx)(e.span,{style:{color:\"var(--base0C)\"},children:\"\\\\/\"}),\"]\",(0,a.jsx)(e.span,{style:{color:\"var(--base0E)\"},children:\"+\"}),\")\",(0,a.jsx)(e.span,{style:{color:\"var(--base0C)\"},children:\"\\\\/\"}),\"([\",(0,a.jsx)(e.span,{style:{color:\"var(--base0E)\"},children:\"^\"}),(0,a.jsx)(e.span,{style:{color:\"var(--base0C)\"},children:\"\\\\/?\"}),\"]\",(0,a.jsx)(e.span,{style:{color:\"var(--base0E)\"},children:\"+\"}),\")\",(0,a.jsx)(e.span,{style:{color:\"var(--base0E)\"},children:\"?\"}),(0,a.jsx)(e.span,{style:{color:\"var(--base0C)\"},children:\".\"}),(0,a.jsx)(e.span,{style:{color:\"var(--base0E)\"},children:\"*\"}),\"/\",\";\",`\n`]}),(0,a.jsxs)(e.span,{className:\"codeblock-line\",\"data-line-number\":\"4\",children:[\"  \",(0,a.jsx)(e.span,{style:{color:\"var(--base0A)\"},children:\"const\"}),\" \",(0,a.jsx)(e.span,{style:{color:\"var(--base08)\"},children:\"match\"}),\" \",(0,a.jsx)(e.span,{style:{color:\"var(--base0E)\"},children:\"=\"}),\" \",(0,a.jsx)(e.span,{style:{color:\"var(--base08)\"},children:\"requestUrl\"}),\".\",(0,a.jsx)(e.span,{style:{color:\"var(--base0D)\"},children:\"match\"}),\"(\",(0,a.jsx)(e.span,{style:{color:\"var(--base08)\"},children:\"regex\"}),\");\",`\n`]}),(0,a.jsx)(e.span,{className:\"codeblock-line\",\"data-line-number\":\"5\",children:`\n`}),(0,a.jsxs)(e.span,{className:\"codeblock-line\",\"data-line-number\":\"6\",children:[\"  \",(0,a.jsx)(e.span,{style:{color:\"var(--base0E)\"},children:\"if\"}),\" (\",(0,a.jsx)(e.span,{style:{color:\"var(--base0E)\"},children:\"!\"}),(0,a.jsx)(e.span,{style:{color:\"var(--base08)\"},children:\"match\"}),\") {\",`\n`]}),(0,a.jsxs)(e.span,{className:\"codeblock-line\",\"data-line-number\":\"7\",children:[\"    \",(0,a.jsx)(e.span,{style:{color:\"var(--base0E)\"},children:\"throw\"}),\" \",(0,a.jsx)(e.span,{style:{color:\"var(--base0E)\"},children:\"new\"}),\" \",(0,a.jsx)(e.span,{style:{color:\"var(--base0D)\"},children:\"Error\"}),\"(\",'\"',(0,a.jsx)(e.span,{style:{color:\"var(--base0B)\"},children:\"Invalid request url \"}),'\"',\" \",(0,a.jsx)(e.span,{style:{color:\"var(--base0E)\"},children:\"+\"}),\" \",(0,a.jsx)(e.span,{style:{color:\"var(--base08)\"},children:\"requestUrl\"}),\");\",`\n`]}),(0,a.jsxs)(e.span,{className:\"codeblock-line\",\"data-line-number\":\"8\",children:[\"  }\",`\n`]}),(0,a.jsx)(e.span,{className:\"codeblock-line\",\"data-line-number\":\"9\",children:`\n`}),(0,a.jsxs)(e.span,{className:\"codeblock-line\",\"data-line-number\":\"10\",children:[\"  \",(0,a.jsx)(e.span,{style:{color:\"var(--base0A)\"},children:\"const\"}),\" [, \",(0,a.jsx)(e.span,{style:{color:\"var(--base08)\"},children:\"showId\"}),\", \",(0,a.jsx)(e.span,{style:{color:\"var(--base08)\"},children:\"format\"}),\", \",(0,a.jsx)(e.span,{style:{color:\"var(--base08)\"},children:\"filename\"}),\"] \",(0,a.jsx)(e.span,{style:{color:\"var(--base0E)\"},children:\"=\"}),\" \",(0,a.jsx)(e.span,{style:{color:\"var(--base08)\"},children:\"match\"}),\";\",`\n`]}),(0,a.jsx)(e.span,{className:\"codeblock-line\",\"data-line-number\":\"11\",children:`\n`}),(0,a.jsxs)(e.span,{className:\"codeblock-line\",\"data-line-number\":\"12\",children:[\"  \",(0,a.jsx)(e.span,{style:{color:\"var(--base03)\"},children:\"// TODO: validate params...\"}),`\n`]}),(0,a.jsx)(e.span,{className:\"codeblock-line\",\"data-line-number\":\"13\",children:`\n`}),(0,a.jsxs)(e.span,{className:\"codeblock-line\",\"data-line-number\":\"14\",children:[\"  \",(0,a.jsx)(e.span,{style:{color:\"var(--base0E)\"},children:\"return\"}),\" {\",`\n`]}),(0,a.jsxs)(e.span,{className:\"codeblock-line\",\"data-line-number\":\"15\",children:[\"    \",(0,a.jsx)(e.span,{style:{color:\"var(--base08)\"},children:\"showId\"}),\",\",`\n`]}),(0,a.jsxs)(e.span,{className:\"codeblock-line\",\"data-line-number\":\"16\",children:[\"    \",(0,a.jsx)(e.span,{style:{color:\"var(--base08)\"},children:\"format\"}),\",\",`\n`]}),(0,a.jsxs)(e.span,{className:\"codeblock-line\",\"data-line-number\":\"17\",children:[\"    \",(0,a.jsx)(e.span,{style:{color:\"var(--base08)\"},children:\"filename\"}),\",\",`\n`]}),(0,a.jsxs)(e.span,{className:\"codeblock-line\",\"data-line-number\":\"18\",children:[\"  };\",`\n`]}),(0,a.jsxs)(e.span,{className:\"codeblock-line\",\"data-line-number\":\"19\",children:[\"}\",`\n`]}),(0,a.jsx)(e.span,{className:\"codeblock-line\",\"data-line-number\":\"20\",children:`\n`}),(0,a.jsxs)(e.span,{className:\"codeblock-line\",\"data-line-number\":\"21\",children:[(0,a.jsx)(e.span,{style:{color:\"var(--base0E)\"},children:\"async\"}),\" \",(0,a.jsx)(e.span,{style:{color:\"var(--base0D)\"},children:\"function\"}),\" \",(0,a.jsx)(e.span,{style:{color:\"var(--base0D)\"},children:\"handler\"}),\" (\",(0,a.jsx)(e.span,{style:{color:\"var(--base08)\"},children:\"event\"}),\") {\",`\n`]}),(0,a.jsxs)(e.span,{className:\"codeblock-line\",\"data-line-number\":\"22\",children:[\"  \",(0,a.jsx)(e.span,{style:{color:\"var(--base0A)\"},children:\"const\"}),\" \",(0,a.jsx)(e.span,{style:{color:\"var(--base08)\"},children:\"request\"}),\" \",(0,a.jsx)(e.span,{style:{color:\"var(--base0E)\"},children:\"=\"}),\" \",(0,a.jsx)(e.span,{style:{color:\"var(--base08)\"},children:\"event\"}),\".\",(0,a.jsx)(e.span,{style:{color:\"var(--base08)\"},children:\"Records\"}),\"[\",(0,a.jsx)(e.span,{style:{color:\"var(--base09)\"},children:\"0\"}),\"].\",(0,a.jsx)(e.span,{style:{color:\"var(--base0D)\"},children:\"cf\"}),\".\",(0,a.jsx)(e.span,{style:{color:\"var(--base08)\"},children:\"request\"}),\";\",`\n`]}),(0,a.jsxs)(e.span,{className:\"codeblock-line\",\"data-line-number\":\"23\",children:[\"  \",(0,a.jsx)(e.span,{style:{color:\"var(--base0A)\"},children:\"const\"}),\" \",(0,a.jsx)(e.span,{style:{color:\"var(--base08)\"},children:\"uri\"}),\" \",(0,a.jsx)(e.span,{style:{color:\"var(--base0E)\"},children:\"=\"}),\" \",(0,a.jsx)(e.span,{style:{color:\"var(--base08)\"},children:\"request\"}),\".\",(0,a.jsx)(e.span,{style:{color:\"var(--base08)\"},children:\"uri\"}),\";\",`\n`]}),(0,a.jsx)(e.span,{className:\"codeblock-line\",\"data-line-number\":\"24\",children:`\n`}),(0,a.jsxs)(e.span,{className:\"codeblock-line\",\"data-line-number\":\"25\",children:[\"  \",(0,a.jsx)(e.span,{style:{color:\"var(--base0E)\"},children:\"try\"}),\" {\",`\n`]}),(0,a.jsxs)(e.span,{className:\"codeblock-line\",\"data-line-number\":\"26\",children:[\"    \",(0,a.jsx)(e.span,{style:{color:\"var(--base0A)\"},children:\"const\"}),\" { \",(0,a.jsx)(e.span,{style:{color:\"var(--base08)\"},children:\"showId\"}),\", \",(0,a.jsx)(e.span,{style:{color:\"var(--base08)\"},children:\"format\"}),\", \",(0,a.jsx)(e.span,{style:{color:\"var(--base08)\"},children:\"filename\"}),\" } \",(0,a.jsx)(e.span,{style:{color:\"var(--base0E)\"},children:\"=\"}),`\n`]}),(0,a.jsxs)(e.span,{className:\"codeblock-line\",\"data-line-number\":\"27\",children:[\"      \",(0,a.jsx)(e.span,{style:{color:\"var(--base0D)\"},children:\"parseRequestParams\"}),\"(\",(0,a.jsx)(e.span,{style:{color:\"var(--base08)\"},children:\"uri\"}),\");\",`\n`]}),(0,a.jsx)(e.span,{className:\"codeblock-line\",\"data-line-number\":\"28\",children:`\n`}),(0,a.jsxs)(e.span,{className:\"codeblock-line\",\"data-line-number\":\"29\",children:[\"    \",(0,a.jsx)(e.span,{style:{color:\"var(--base0A)\"},children:\"const\"}),\" \",(0,a.jsx)(e.span,{style:{color:\"var(--base08)\"},children:\"domainName\"}),\" \",(0,a.jsx)(e.span,{style:{color:\"var(--base0E)\"},children:\"=\"}),\" \",\"`${\",(0,a.jsx)(e.span,{style:{color:\"var(--base08)\"},children:\"showId\"}),\"}\",(0,a.jsx)(e.span,{style:{color:\"var(--base0B)\"},children:\".mediapackagev2.eu-west-1.amazonaws.com\"}),\"`\",\";\",`\n`]}),(0,a.jsxs)(e.span,{className:\"codeblock-line\",\"data-line-number\":\"30\",children:[\"    \",(0,a.jsx)(e.span,{style:{color:\"var(--base0A)\"},children:\"const\"}),\" \",(0,a.jsx)(e.span,{style:{color:\"var(--base08)\"},children:\"path\"}),\" \",(0,a.jsx)(e.span,{style:{color:\"var(--base0E)\"},children:\"=\"}),\" \",\"`\",(0,a.jsx)(e.span,{style:{color:\"var(--base0B)\"},children:\"/out/v1/\"}),\"${\",(0,a.jsx)(e.span,{style:{color:\"var(--base08)\"},children:\"showId\"}),\"}\",(0,a.jsx)(e.span,{style:{color:\"var(--base0B)\"},children:\"-group/\"}),\"${\",(0,a.jsx)(e.span,{style:{color:\"var(--base08)\"},children:\"format\"}),\"}\",(0,a.jsx)(e.span,{style:{color:\"var(--base0B)\"},children:\"/\"}),\"${\",(0,a.jsx)(e.span,{style:{color:\"var(--base08)\"},children:\"format\"}),\"}\",(0,a.jsx)(e.span,{style:{color:\"var(--base0B)\"},children:\"/\"}),\"${\",(0,a.jsx)(e.span,{style:{color:\"var(--base08)\"},children:\"filename\"}),\"}`\",\";\",`\n`]}),(0,a.jsx)(e.span,{className:\"codeblock-line\",\"data-line-number\":\"31\",children:`\n`}),(0,a.jsxs)(e.span,{className:\"codeblock-line\",\"data-line-number\":\"32\",children:[\"    \",(0,a.jsx)(e.span,{style:{color:\"var(--base03)\"},children:\"// Update the URL\"}),`\n`]}),(0,a.jsxs)(e.span,{className:\"codeblock-line\",\"data-line-number\":\"33\",children:[\"    \",(0,a.jsx)(e.span,{style:{color:\"var(--base08)\"},children:\"request\"}),\".\",(0,a.jsx)(e.span,{style:{color:\"var(--base08)\"},children:\"origin\"}),(0,a.jsx)(e.span,{style:{color:\"var(--base0E)\"},children:\"!\"}),\".\",(0,a.jsx)(e.span,{style:{color:\"var(--base08)\"},children:\"custom\"}),(0,a.jsx)(e.span,{style:{color:\"var(--base0E)\"},children:\"!\"}),\".\",(0,a.jsx)(e.span,{style:{color:\"var(--base08)\"},children:\"domainName\"}),\" \",(0,a.jsx)(e.span,{style:{color:\"var(--base0E)\"},children:\"=\"}),\" \",(0,a.jsx)(e.span,{style:{color:\"var(--base08)\"},children:\"domainName\"}),\";\",`\n`]}),(0,a.jsxs)(e.span,{className:\"codeblock-line\",\"data-line-number\":\"34\",children:[\"    \",(0,a.jsx)(e.span,{style:{color:\"var(--base08)\"},children:\"request\"}),\".\",(0,a.jsx)(e.span,{style:{color:\"var(--base08)\"},children:\"uri\"}),\" \",(0,a.jsx)(e.span,{style:{color:\"var(--base0E)\"},children:\"=\"}),\" \",(0,a.jsx)(e.span,{style:{color:\"var(--base08)\"},children:\"path\"}),\";\",`\n`]}),(0,a.jsxs)(e.span,{className:\"codeblock-line\",\"data-line-number\":\"35\",children:[\"    \",(0,a.jsx)(e.span,{style:{color:\"var(--base08)\"},children:\"request\"}),\".\",(0,a.jsx)(e.span,{style:{color:\"var(--base08)\"},children:\"headers\"}),\"[\",'\"',(0,a.jsx)(e.span,{style:{color:\"var(--base0B)\"},children:\"host\"}),'\"',\"] \",(0,a.jsx)(e.span,{style:{color:\"var(--base0E)\"},children:\"=\"}),\" [{ key: \",'\"',(0,a.jsx)(e.span,{style:{color:\"var(--base0B)\"},children:\"Host\"}),'\"',\", value: \",(0,a.jsx)(e.span,{style:{color:\"var(--base08)\"},children:\"domainName\"}),\" }];\",`\n`]}),(0,a.jsxs)(e.span,{className:\"codeblock-line\",\"data-line-number\":\"36\",children:[\"    \",(0,a.jsx)(e.span,{style:{color:\"var(--base08)\"},children:\"console\"}),\".\",(0,a.jsx)(e.span,{style:{color:\"var(--base0D)\"},children:\"log\"}),\"(\",(0,a.jsx)(e.span,{style:{color:\"var(--base08)\"},children:\"request\"}),\");\",`\n`]}),(0,a.jsxs)(e.span,{className:\"codeblock-line\",\"data-line-number\":\"37\",children:[\"  } \",(0,a.jsx)(e.span,{style:{color:\"var(--base0E)\"},children:\"catch\"}),\" (\",(0,a.jsx)(e.span,{style:{color:\"var(--base08)\"},children:\"error\"}),\") {\",`\n`]}),(0,a.jsxs)(e.span,{className:\"codeblock-line\",\"data-line-number\":\"38\",children:[\"    \",(0,a.jsx)(e.span,{style:{color:\"var(--base03)\"},children:\"// If something goes wrong, keep the original request and do no routing\"}),`\n`]}),(0,a.jsxs)(e.span,{className:\"codeblock-line\",\"data-line-number\":\"39\",children:[\"    \",(0,a.jsx)(e.span,{style:{color:\"var(--base03)\"},children:\"// TODO: redirect to a custom not found page\"}),`\n`]}),(0,a.jsxs)(e.span,{className:\"codeblock-line\",\"data-line-number\":\"40\",children:[\"    \",(0,a.jsx)(e.span,{style:{color:\"var(--base08)\"},children:\"console\"}),\".\",(0,a.jsx)(e.span,{style:{color:\"var(--base0D)\"},children:\"error\"}),\"(\",(0,a.jsx)(e.span,{style:{color:\"var(--base08)\"},children:\"error\"}),\");\",`\n`]}),(0,a.jsxs)(e.span,{className:\"codeblock-line\",\"data-line-number\":\"41\",children:[\"  }\",`\n`]}),(0,a.jsx)(e.span,{className:\"codeblock-line\",\"data-line-number\":\"42\",children:`\n`}),(0,a.jsxs)(e.span,{className:\"codeblock-line\",\"data-line-number\":\"43\",children:[\"  \",(0,a.jsx)(e.span,{style:{color:\"var(--base0E)\"},children:\"return\"}),\" \",(0,a.jsx)(e.span,{style:{color:\"var(--base08)\"},children:\"request\"}),\";\",`\n`]}),(0,a.jsxs)(e.span,{className:\"codeblock-line\",\"data-line-number\":\"44\",children:[\"};\",`\n`]}),(0,a.jsx)(e.span,{className:\"codeblock-line\",\"data-line-number\":\"45\",children:`\n`}),(0,a.jsxs)(e.span,{className:\"codeblock-line\",\"data-line-number\":\"46\",children:[(0,a.jsx)(e.span,{style:{color:\"var(--base0C)\"},children:\"module\"}),\".\",(0,a.jsx)(e.span,{style:{color:\"var(--base0C)\"},children:\"exports\"}),\" \",(0,a.jsx)(e.span,{style:{color:\"var(--base0E)\"},children:\"=\"}),\" { \",(0,a.jsx)(e.span,{style:{color:\"var(--base08)\"},children:\"handler\"}),\" };\",`\n`]})]})}),`\n`,(0,a.jsxs)(l,{summary:\"Using TypeScript? Here's the type definitions for the handler function\",children:[(0,a.jsxs)(e.p,{children:[\"Just import the types \",(0,a.jsx)(e.code,{children:\"CloudFrontRequestEvent\"}),\",  \",(0,a.jsx)(e.code,{children:\"CloudFrontRequestHandler\"}),\" and \",(0,a.jsx)(e.code,{children:\"CloudFrontRequestResult\"}),\" from \",(0,a.jsx)(e.code,{children:\"@types/aws-lambda\"}),\" package.\"]}),(0,a.jsx)(e.pre,{\"data-line-numbers\":\"true\",tabIndex:\"0\",\"data-lang\":\"typescript\",style:{color:\"var(--base05)\",backgroundColor:\"var(--base00)\"},children:(0,a.jsxs)(e.code,{children:[(0,a.jsxs)(e.span,{className:\"codeblock-line\",\"data-line-number\":\"1\",children:[(0,a.jsx)(e.span,{style:{color:\"var(--base0E)\"},children:\"import\"}),\" \",(0,a.jsx)(e.span,{style:{color:\"var(--base0E)\"},children:\"type\"}),\" {\",`\n`]}),(0,a.jsxs)(e.span,{className:\"codeblock-line\",\"data-line-number\":\"2\",children:[\"  \",(0,a.jsx)(e.span,{style:{color:\"var(--base08)\"},children:\"CloudFrontRequestEvent\"}),\",\",`\n`]}),(0,a.jsxs)(e.span,{className:\"codeblock-line\",\"data-line-number\":\"3\",children:[\"  \",(0,a.jsx)(e.span,{style:{color:\"var(--base08)\"},children:\"CloudFrontRequestHandler\"}),\",\",`\n`]}),(0,a.jsxs)(e.span,{className:\"codeblock-line\",\"data-line-number\":\"4\",children:[\"  \",(0,a.jsx)(e.span,{style:{color:\"var(--base08)\"},children:\"CloudFrontRequestResult\"}),\",\",`\n`]}),(0,a.jsxs)(e.span,{className:\"codeblock-line\",\"data-line-number\":\"5\",children:[\"} \",(0,a.jsx)(e.span,{style:{color:\"var(--base0E)\"},children:\"from\"}),\" \",'\"',(0,a.jsx)(e.span,{style:{color:\"var(--base0B)\"},children:\"aws-lambda\"}),'\"',\";\",`\n`]}),(0,a.jsx)(e.span,{className:\"codeblock-line\",\"data-line-number\":\"6\",children:`\n`}),(0,a.jsxs)(e.span,{className:\"codeblock-line\",\"data-line-number\":\"7\",children:[(0,a.jsx)(e.span,{style:{color:\"var(--base03)\"},children:\"// Match the following signature\"}),`\n`]}),(0,a.jsxs)(e.span,{className:\"codeblock-line\",\"data-line-number\":\"8\",children:[(0,a.jsx)(e.span,{style:{color:\"var(--base0A)\"},children:\"type\"}),\" \",(0,a.jsx)(e.span,{style:{color:\"var(--base0A)\"},children:\"Handler\"}),\" \",(0,a.jsx)(e.span,{style:{color:\"var(--base0E)\"},children:\"=\"}),\" (\",(0,a.jsx)(e.span,{style:{color:\"var(--base08)\"},children:\"event\"}),(0,a.jsx)(e.span,{style:{color:\"var(--base0E)\"},children:\":\"}),\" \",(0,a.jsx)(e.span,{style:{color:\"var(--base0A)\"},children:\"CloudFrontRequestEvent\"}),\") \",(0,a.jsx)(e.span,{style:{color:\"var(--base0D)\"},children:\"=>\"}),\" \",(0,a.jsx)(e.span,{style:{color:\"var(--base0A)\"},children:\"Promise\"}),\"<\",(0,a.jsx)(e.span,{style:{color:\"var(--base0A)\"},children:\"CloudFrontRequestResult\"}),\">\",`\n`]})]})})]}),`\n`,(0,a.jsxs)(e.h3,{id:\"step-2-deploy-the-lambda-function\",children:[(0,a.jsx)(e.a,{\"aria-hidden\":\"true\",tabIndex:\"-1\",href:\"#step-2-deploy-the-lambda-function\",children:(0,a.jsx)(e.span,{className:\"icon icon-link\"})}),\"Step 2: Deploy the Lambda function\"]}),`\n`,(0,a.jsxs)(e.p,{children:[\"Now that we have the Lambda function ready, we can deploy it using the Serverless Framework. In my case, I'm deploying the CloudFront distribution and the Lambda function in the same stack, here's the \",(0,a.jsx)(e.code,{children:\"serverless.yml\"}),\" file:\"]}),`\n`,(0,a.jsx)(e.pre,{\"data-line-numbers\":\"true\",tabIndex:\"0\",\"data-lang\":\"yaml\",style:{color:\"var(--base05)\",backgroundColor:\"var(--base00)\"},children:(0,a.jsxs)(e.code,{children:[(0,a.jsxs)(e.span,{className:\"codeblock-line\",\"data-line-number\":\"1\",children:[(0,a.jsx)(e.span,{style:{color:\"var(--base08)\"},children:\"service\"}),\": \",(0,a.jsx)(e.span,{style:{color:\"var(--base0B)\"},children:\"cloudfront-router\"}),`\n`]}),(0,a.jsxs)(e.span,{className:\"codeblock-line\",\"data-line-number\":\"2\",children:[(0,a.jsx)(e.span,{style:{color:\"var(--base08)\"},children:\"configValidationMode\"}),\": \",(0,a.jsx)(e.span,{style:{color:\"var(--base0B)\"},children:\"error\"}),`\n`]}),(0,a.jsxs)(e.span,{className:\"codeblock-line\",\"data-line-number\":\"3\",children:[(0,a.jsx)(e.span,{style:{color:\"var(--base08)\"},children:\"frameworkVersion\"}),\": \",'\"',(0,a.jsx)(e.span,{style:{color:\"var(--base0B)\"},children:\"3\"}),'\"',`\n`]}),(0,a.jsx)(e.span,{className:\"codeblock-line\",\"data-line-number\":\"4\",children:`\n`}),(0,a.jsxs)(e.span,{className:\"codeblock-line\",\"data-line-number\":\"5\",children:[(0,a.jsx)(e.span,{style:{color:\"var(--base08)\"},children:\"plugins\"}),\":\",`\n`]}),(0,a.jsxs)(e.span,{className:\"codeblock-line\",\"data-line-number\":\"6\",children:[\"  \",(0,a.jsx)(e.span,{style:{color:\"var(--base03)\"},children:\"# Using this plugin for a simpler CF configuration than the native \"}),`\n`]}),(0,a.jsxs)(e.span,{className:\"codeblock-line\",\"data-line-number\":\"7\",children:[\"  \",(0,a.jsx)(e.span,{style:{color:\"var(--base03)\"},children:\"# offering from the Serverless Framework\"}),`\n`]}),(0,a.jsxs)(e.span,{className:\"codeblock-line\",\"data-line-number\":\"8\",children:[\"  - \",'\"',(0,a.jsx)(e.span,{style:{color:\"var(--base0B)\"},children:\"@silvermine/serverless-plugin-cloudfront-lambda-edge\"}),'\"',`\n`]}),(0,a.jsx)(e.span,{className:\"codeblock-line\",\"data-line-number\":\"9\",children:`\n`}),(0,a.jsxs)(e.span,{className:\"codeblock-line\",\"data-line-number\":\"10\",children:[(0,a.jsx)(e.span,{style:{color:\"var(--base08)\"},children:\"provider\"}),\":\",`\n`]}),(0,a.jsxs)(e.span,{className:\"codeblock-line\",\"data-line-number\":\"11\",children:[\"  \",(0,a.jsx)(e.span,{style:{color:\"var(--base08)\"},children:\"name\"}),\": \",(0,a.jsx)(e.span,{style:{color:\"var(--base0B)\"},children:\"aws\"}),`\n`]}),(0,a.jsxs)(e.span,{className:\"codeblock-line\",\"data-line-number\":\"12\",children:[\"  \",(0,a.jsx)(e.span,{style:{color:\"var(--base03)\"},children:\"# Lambda@Edge requires the function to be deployed in us-east-1 (Virginia)!\"}),`\n`]}),(0,a.jsxs)(e.span,{className:\"codeblock-line\",\"data-line-number\":\"13\",children:[\"  \",(0,a.jsx)(e.span,{style:{color:\"var(--base08)\"},children:\"region\"}),\": \",(0,a.jsx)(e.span,{style:{color:\"var(--base0B)\"},children:\"us-east-1\"}),`\n`]}),(0,a.jsxs)(e.span,{className:\"codeblock-line\",\"data-line-number\":\"14\",children:[\"  \",(0,a.jsx)(e.span,{style:{color:\"var(--base08)\"},children:\"runtime\"}),\": \",(0,a.jsx)(e.span,{style:{color:\"var(--base0B)\"},children:\"nodejs18.x\"}),`\n`]}),(0,a.jsx)(e.span,{className:\"codeblock-line\",\"data-line-number\":\"15\",children:`\n`}),(0,a.jsxs)(e.span,{className:\"codeblock-line\",\"data-line-number\":\"16\",children:[(0,a.jsx)(e.span,{style:{color:\"var(--base03)\"},children:\"# Remember to enter the pattern (path) to the files you'll use for the function\"}),`\n`]}),(0,a.jsxs)(e.span,{className:\"codeblock-line\",\"data-line-number\":\"17\",children:[(0,a.jsx)(e.span,{style:{color:\"var(--base08)\"},children:\"package\"}),\":\",`\n`]}),(0,a.jsxs)(e.span,{className:\"codeblock-line\",\"data-line-number\":\"18\",children:[\"  \",(0,a.jsx)(e.span,{style:{color:\"var(--base08)\"},children:\"pattern\"}),\":\",`\n`]}),(0,a.jsxs)(e.span,{className:\"codeblock-line\",\"data-line-number\":\"19\",children:[\"    \",(0,a.jsx)(e.span,{style:{color:\"var(--base0B)\"},children:\"src/**/*\"}),`\n`]}),(0,a.jsx)(e.span,{className:\"codeblock-line\",\"data-line-number\":\"20\",children:`\n`}),(0,a.jsxs)(e.span,{className:\"codeblock-line\",\"data-line-number\":\"21\",children:[(0,a.jsx)(e.span,{style:{color:\"var(--base08)\"},children:\"resources\"}),\":\",`\n`]}),(0,a.jsxs)(e.span,{className:\"codeblock-line\",\"data-line-number\":\"22\",children:[\"  \",(0,a.jsx)(e.span,{style:{color:\"var(--base08)\"},children:\"Resources\"}),\":\",`\n`]}),(0,a.jsxs)(e.span,{className:\"codeblock-line\",\"data-line-number\":\"23\",children:[\"    \",(0,a.jsx)(e.span,{style:{color:\"var(--base08)\"},children:\"MediaCloudFrontDistribution\"}),\":\",`\n`]}),(0,a.jsxs)(e.span,{className:\"codeblock-line\",\"data-line-number\":\"24\",children:[\"      \",(0,a.jsx)(e.span,{style:{color:\"var(--base08)\"},children:\"Type\"}),\": \",(0,a.jsx)(e.span,{style:{color:\"var(--base0B)\"},children:\"AWS::CloudFront::Distribution\"}),`\n`]}),(0,a.jsxs)(e.span,{className:\"codeblock-line\",\"data-line-number\":\"25\",children:[\"      \",(0,a.jsx)(e.span,{style:{color:\"var(--base08)\"},children:\"Properties\"}),\":\",`\n`]}),(0,a.jsxs)(e.span,{className:\"codeblock-line\",\"data-line-number\":\"26\",children:[\"        \",(0,a.jsx)(e.span,{style:{color:\"var(--base08)\"},children:\"DistributionConfig\"}),\":\",`\n`]}),(0,a.jsxs)(e.span,{className:\"codeblock-line\",\"data-line-number\":\"27\",children:[\"          \",(0,a.jsx)(e.span,{style:{color:\"var(--base08)\"},children:\"Enabled\"}),\": \",(0,a.jsx)(e.span,{style:{color:\"var(--base09)\"},children:\"true\"}),`\n`]}),(0,a.jsxs)(e.span,{className:\"codeblock-line\",\"data-line-number\":\"28\",children:[\"          \",(0,a.jsx)(e.span,{style:{color:\"var(--base08)\"},children:\"DefaultCacheBehavior\"}),\":\",`\n`]}),(0,a.jsxs)(e.span,{className:\"codeblock-line\",\"data-line-number\":\"29\",children:[\"            \",(0,a.jsx)(e.span,{style:{color:\"var(--base08)\"},children:\"TargetOriginId\"}),\": \",(0,a.jsx)(e.span,{style:{color:\"var(--base0B)\"},children:\"DefaultOrigin\"}),`\n`]}),(0,a.jsxs)(e.span,{className:\"codeblock-line\",\"data-line-number\":\"30\",children:[\"            \",(0,a.jsx)(e.span,{style:{color:\"var(--base08)\"},children:\"ViewerProtocolPolicy\"}),\": \",(0,a.jsx)(e.span,{style:{color:\"var(--base0B)\"},children:\"redirect-to-https\"}),`\n`]}),(0,a.jsxs)(e.span,{className:\"codeblock-line\",\"data-line-number\":\"31\",children:[\"            \",(0,a.jsx)(e.span,{style:{color:\"var(--base08)\"},children:\"AllowedMethods\"}),\":\",`\n`]}),(0,a.jsxs)(e.span,{className:\"codeblock-line\",\"data-line-number\":\"32\",children:[\"              - \",(0,a.jsx)(e.span,{style:{color:\"var(--base0B)\"},children:\"GET\"}),`\n`]}),(0,a.jsxs)(e.span,{className:\"codeblock-line\",\"data-line-number\":\"33\",children:[\"              - \",(0,a.jsx)(e.span,{style:{color:\"var(--base0B)\"},children:\"HEAD\"}),`\n`]}),(0,a.jsxs)(e.span,{className:\"codeblock-line\",\"data-line-number\":\"34\",children:[\"            \",(0,a.jsx)(e.span,{style:{color:\"var(--base08)\"},children:\"CachedMethods\"}),\":\",`\n`]}),(0,a.jsxs)(e.span,{className:\"codeblock-line\",\"data-line-number\":\"35\",children:[\"              - \",(0,a.jsx)(e.span,{style:{color:\"var(--base0B)\"},children:\"GET\"}),`\n`]}),(0,a.jsxs)(e.span,{className:\"codeblock-line\",\"data-line-number\":\"36\",children:[\"              - \",(0,a.jsx)(e.span,{style:{color:\"var(--base0B)\"},children:\"HEAD\"}),`\n`]}),(0,a.jsxs)(e.span,{className:\"codeblock-line\",\"data-line-number\":\"37\",children:[\"            \",(0,a.jsx)(e.span,{style:{color:\"var(--base08)\"},children:\"ForwardedValues\"}),\":\",`\n`]}),(0,a.jsxs)(e.span,{className:\"codeblock-line\",\"data-line-number\":\"38\",children:[\"              \",(0,a.jsx)(e.span,{style:{color:\"var(--base08)\"},children:\"QueryString\"}),\": \",(0,a.jsx)(e.span,{style:{color:\"var(--base09)\"},children:\"true\"}),`\n`]}),(0,a.jsxs)(e.span,{className:\"codeblock-line\",\"data-line-number\":\"39\",children:[\"              \",(0,a.jsx)(e.span,{style:{color:\"var(--base08)\"},children:\"Cookies\"}),\":\",`\n`]}),(0,a.jsxs)(e.span,{className:\"codeblock-line\",\"data-line-number\":\"40\",children:[\"                \",(0,a.jsx)(e.span,{style:{color:\"var(--base08)\"},children:\"Forward\"}),\": \",(0,a.jsx)(e.span,{style:{color:\"var(--base0B)\"},children:\"none\"}),`\n`]}),(0,a.jsxs)(e.span,{className:\"codeblock-line\",\"data-line-number\":\"41\",children:[\"            \",(0,a.jsx)(e.span,{style:{color:\"var(--base08)\"},children:\"ResponseHeadersPolicyId\"}),\": \",(0,a.jsx)(e.span,{style:{color:\"var(--base0A)\"},children:\"!Ref\"}),\" \",(0,a.jsx)(e.span,{style:{color:\"var(--base0B)\"},children:\"MediaCFResponseHeadersPolicy\"}),`\n`]}),(0,a.jsxs)(e.span,{className:\"codeblock-line\",\"data-line-number\":\"42\",children:[\"            \",(0,a.jsx)(e.span,{style:{color:\"var(--base08)\"},children:\"Compress\"}),\": \",(0,a.jsx)(e.span,{style:{color:\"var(--base09)\"},children:\"true\"}),`\n`]}),(0,a.jsxs)(e.span,{className:\"codeblock-line\",\"data-line-number\":\"43\",children:[\"          \",(0,a.jsx)(e.span,{style:{color:\"var(--base08)\"},children:\"ViewerCertificate\"}),\":\",`\n`]}),(0,a.jsxs)(e.span,{className:\"codeblock-line\",\"data-line-number\":\"44\",children:[\"            \",(0,a.jsx)(e.span,{style:{color:\"var(--base08)\"},children:\"CloudFrontDefaultCertificate\"}),\": \",(0,a.jsx)(e.span,{style:{color:\"var(--base09)\"},children:\"true\"}),`\n`]}),(0,a.jsxs)(e.span,{className:\"codeblock-line\",\"data-line-number\":\"45\",children:[\"          \",(0,a.jsx)(e.span,{style:{color:\"var(--base08)\"},children:\"HttpVersion\"}),\": \",(0,a.jsx)(e.span,{style:{color:\"var(--base0B)\"},children:\"http2\"}),`\n`]}),(0,a.jsxs)(e.span,{className:\"codeblock-line\",\"data-line-number\":\"46\",children:[\"          \",(0,a.jsx)(e.span,{style:{color:\"var(--base08)\"},children:\"PriceClass\"}),\": \",(0,a.jsx)(e.span,{style:{color:\"var(--base0B)\"},children:\"PriceClass_100\"}),`\n`]}),(0,a.jsxs)(e.span,{className:\"codeblock-line\",\"data-line-number\":\"47\",children:[\"          \",(0,a.jsx)(e.span,{style:{color:\"var(--base08)\"},children:\"Origins\"}),\":\",`\n`]}),(0,a.jsxs)(e.span,{className:\"codeblock-line\",\"data-line-number\":\"48\",children:[\"            - \",(0,a.jsx)(e.span,{style:{color:\"var(--base08)\"},children:\"Id\"}),\": \",'\"',(0,a.jsx)(e.span,{style:{color:\"var(--base0B)\"},children:\"DefaultOrigin\"}),'\"',`\n`]}),(0,a.jsxs)(e.span,{className:\"codeblock-line\",\"data-line-number\":\"49\",children:[\"              \",(0,a.jsx)(e.span,{style:{color:\"var(--base03)\"},children:\"# This domain needs to match the domain you use in your\"}),`\n`]}),(0,a.jsxs)(e.span,{className:\"codeblock-line\",\"data-line-number\":\"50\",children:[\"              \",(0,a.jsx)(e.span,{style:{color:\"var(--base03)\"},children:\"# Lambda code.\"}),`\n`]}),(0,a.jsxs)(e.span,{className:\"codeblock-line\",\"data-line-number\":\"51\",children:[\"              \",(0,a.jsx)(e.span,{style:{color:\"var(--base03)\"},children:\"# --------------\"}),`\n`]}),(0,a.jsxs)(e.span,{className:\"codeblock-line\",\"data-line-number\":\"52\",children:[\"              \",(0,a.jsx)(e.span,{style:{color:\"var(--base03)\"},children:\"# Also - This will be the default request origin if your lambda\"}),`\n`]}),(0,a.jsxs)(e.span,{className:\"codeblock-line\",\"data-line-number\":\"53\",children:[\"              \",(0,a.jsx)(e.span,{style:{color:\"var(--base03)\"},children:\"# doesn't re-route the calls using whatever URL scheme you defined\"}),`\n`]}),(0,a.jsxs)(e.span,{className:\"codeblock-line\",\"data-line-number\":\"54\",children:[\"              \",(0,a.jsx)(e.span,{style:{color:\"var(--base03)\"},children:\"# so make sure this points to somewhere valid inside the domain\"}),`\n`]}),(0,a.jsxs)(e.span,{className:\"codeblock-line\",\"data-line-number\":\"55\",children:[\"              \",(0,a.jsx)(e.span,{style:{color:\"var(--base03)\"},children:\"# you'll redirect to in the Lambda code.\"}),`\n`]}),(0,a.jsx)(e.span,{className:\"codeblock-line\",\"data-line-number\":\"56\",children:`\n`}),(0,a.jsxs)(e.span,{className:\"codeblock-line\",\"data-line-number\":\"57\",children:[\"              \",(0,a.jsx)(e.span,{style:{color:\"var(--base08)\"},children:\"DomainName\"}),\": \",(0,a.jsx)(e.span,{style:{color:\"var(--base0B)\"},children:\"mediapackagev2.eu-west-1.amazonaws.com\"}),`\n`]}),(0,a.jsxs)(e.span,{className:\"codeblock-line\",\"data-line-number\":\"58\",children:[\"              \",(0,a.jsx)(e.span,{style:{color:\"var(--base08)\"},children:\"CustomOriginConfig\"}),\":\",`\n`]}),(0,a.jsxs)(e.span,{className:\"codeblock-line\",\"data-line-number\":\"59\",children:[\"                \",(0,a.jsx)(e.span,{style:{color:\"var(--base08)\"},children:\"HTTPPort\"}),\": \",(0,a.jsx)(e.span,{style:{color:\"var(--base09)\"},children:\"80\"}),`\n`]}),(0,a.jsxs)(e.span,{className:\"codeblock-line\",\"data-line-number\":\"60\",children:[\"                \",(0,a.jsx)(e.span,{style:{color:\"var(--base08)\"},children:\"HTTPSPort\"}),\": \",(0,a.jsx)(e.span,{style:{color:\"var(--base09)\"},children:\"443\"}),`\n`]}),(0,a.jsxs)(e.span,{className:\"codeblock-line\",\"data-line-number\":\"61\",children:[\"                \",(0,a.jsx)(e.span,{style:{color:\"var(--base08)\"},children:\"OriginProtocolPolicy\"}),\": \",'\"',(0,a.jsx)(e.span,{style:{color:\"var(--base0B)\"},children:\"match-viewer\"}),'\"',`\n`]}),(0,a.jsxs)(e.span,{className:\"codeblock-line\",\"data-line-number\":\"62\",children:[\"                \",(0,a.jsx)(e.span,{style:{color:\"var(--base08)\"},children:\"OriginReadTimeout\"}),\": \",(0,a.jsx)(e.span,{style:{color:\"var(--base09)\"},children:\"30\"}),`\n`]}),(0,a.jsxs)(e.span,{className:\"codeblock-line\",\"data-line-number\":\"63\",children:[\"                \",(0,a.jsx)(e.span,{style:{color:\"var(--base08)\"},children:\"OriginKeepaliveTimeout\"}),\": \",(0,a.jsx)(e.span,{style:{color:\"var(--base09)\"},children:\"5\"}),`\n`]}),(0,a.jsxs)(e.span,{className:\"codeblock-line\",\"data-line-number\":\"64\",children:[\"              \",(0,a.jsx)(e.span,{style:{color:\"var(--base08)\"},children:\"ConnectionAttempts\"}),\": \",(0,a.jsx)(e.span,{style:{color:\"var(--base09)\"},children:\"3\"}),`\n`]}),(0,a.jsxs)(e.span,{className:\"codeblock-line\",\"data-line-number\":\"65\",children:[\"              \",(0,a.jsx)(e.span,{style:{color:\"var(--base08)\"},children:\"ConnectionTimeout\"}),\": \",(0,a.jsx)(e.span,{style:{color:\"var(--base09)\"},children:\"10\"}),`\n`]}),(0,a.jsx)(e.span,{className:\"codeblock-line\",\"data-line-number\":\"66\",children:`\n`}),(0,a.jsxs)(e.span,{className:\"codeblock-line\",\"data-line-number\":\"67\",children:[\"    \",(0,a.jsx)(e.span,{style:{color:\"var(--base08)\"},children:\"MediaCFResponseHeadersPolicy\"}),\":\",`\n`]}),(0,a.jsxs)(e.span,{className:\"codeblock-line\",\"data-line-number\":\"68\",children:[\"      \",(0,a.jsx)(e.span,{style:{color:\"var(--base08)\"},children:\"Type\"}),\": \",(0,a.jsx)(e.span,{style:{color:\"var(--base0B)\"},children:\"AWS::CloudFront::ResponseHeadersPolicy\"}),`\n`]}),(0,a.jsxs)(e.span,{className:\"codeblock-line\",\"data-line-number\":\"69\",children:[\"      \",(0,a.jsx)(e.span,{style:{color:\"var(--base08)\"},children:\"Properties\"}),\":\",`\n`]}),(0,a.jsxs)(e.span,{className:\"codeblock-line\",\"data-line-number\":\"70\",children:[\"        \",(0,a.jsx)(e.span,{style:{color:\"var(--base08)\"},children:\"ResponseHeadersPolicyConfig\"}),\":\",`\n`]}),(0,a.jsxs)(e.span,{className:\"codeblock-line\",\"data-line-number\":\"71\",children:[\"          \",(0,a.jsx)(e.span,{style:{color:\"var(--base08)\"},children:\"Name\"}),\": \",'\"',(0,a.jsx)(e.span,{style:{color:\"var(--base0B)\"},children:\"allow-website\"}),'\"',`\n`]}),(0,a.jsxs)(e.span,{className:\"codeblock-line\",\"data-line-number\":\"72\",children:[\"          \",(0,a.jsx)(e.span,{style:{color:\"var(--base08)\"},children:\"Comment\"}),\": \",'\"',(0,a.jsx)(e.span,{style:{color:\"var(--base0B)\"},children:\"Allow main website\"}),'\"',`\n`]}),(0,a.jsxs)(e.span,{className:\"codeblock-line\",\"data-line-number\":\"73\",children:[\"          \",(0,a.jsx)(e.span,{style:{color:\"var(--base08)\"},children:\"CorsConfig\"}),\":\",`\n`]}),(0,a.jsxs)(e.span,{className:\"codeblock-line\",\"data-line-number\":\"74\",children:[\"            \",(0,a.jsx)(e.span,{style:{color:\"var(--base08)\"},children:\"AccessControlAllowCredentials\"}),\": \",(0,a.jsx)(e.span,{style:{color:\"var(--base09)\"},children:\"false\"}),`\n`]}),(0,a.jsxs)(e.span,{className:\"codeblock-line\",\"data-line-number\":\"75\",children:[\"            \",(0,a.jsx)(e.span,{style:{color:\"var(--base08)\"},children:\"AccessControlAllowMethods\"}),\":\",`\n`]}),(0,a.jsxs)(e.span,{className:\"codeblock-line\",\"data-line-number\":\"76\",children:[\"              \",(0,a.jsx)(e.span,{style:{color:\"var(--base08)\"},children:\"Items\"}),\":\",`\n`]}),(0,a.jsxs)(e.span,{className:\"codeblock-line\",\"data-line-number\":\"77\",children:[\"                - \",'\"',(0,a.jsx)(e.span,{style:{color:\"var(--base0B)\"},children:\"GET\"}),'\"',`\n`]}),(0,a.jsxs)(e.span,{className:\"codeblock-line\",\"data-line-number\":\"78\",children:[\"            \",(0,a.jsx)(e.span,{style:{color:\"var(--base08)\"},children:\"AccessControlAllowOrigins\"}),\":\",`\n`]}),(0,a.jsxs)(e.span,{className:\"codeblock-line\",\"data-line-number\":\"79\",children:[\"              \",(0,a.jsx)(e.span,{style:{color:\"var(--base08)\"},children:\"Items\"}),\":\",`\n`]}),(0,a.jsxs)(e.span,{className:\"codeblock-line\",\"data-line-number\":\"80\",children:[\"                \",(0,a.jsx)(e.span,{style:{color:\"var(--base03)\"},children:\"# Remember to use your actual domain here\"}),`\n`]}),(0,a.jsxs)(e.span,{className:\"codeblock-line\",\"data-line-number\":\"81\",children:[\"                - \",'\"',(0,a.jsx)(e.span,{style:{color:\"var(--base0B)\"},children:\"example.com\"}),'\"',`\n`]}),(0,a.jsxs)(e.span,{className:\"codeblock-line\",\"data-line-number\":\"82\",children:[\"            \",(0,a.jsx)(e.span,{style:{color:\"var(--base08)\"},children:\"OriginOverride\"}),\": \",(0,a.jsx)(e.span,{style:{color:\"var(--base09)\"},children:\"true\"}),`\n`]}),(0,a.jsxs)(e.span,{className:\"codeblock-line\",\"data-line-number\":\"83\",children:[\"  \",(0,a.jsx)(e.span,{style:{color:\"var(--base03)\"},children:\"# These outputs are more for reference, they'll help you debug\"}),`\n`]}),(0,a.jsxs)(e.span,{className:\"codeblock-line\",\"data-line-number\":\"84\",children:[\"  \",(0,a.jsx)(e.span,{style:{color:\"var(--base03)\"},children:\"# your CF distribution if necessary\"}),`\n`]}),(0,a.jsxs)(e.span,{className:\"codeblock-line\",\"data-line-number\":\"85\",children:[\"  \",(0,a.jsx)(e.span,{style:{color:\"var(--base08)\"},children:\"Outputs\"}),\":\",`\n`]}),(0,a.jsxs)(e.span,{className:\"codeblock-line\",\"data-line-number\":\"86\",children:[\"    \",(0,a.jsx)(e.span,{style:{color:\"var(--base08)\"},children:\"DistributionId\"}),\":\",`\n`]}),(0,a.jsxs)(e.span,{className:\"codeblock-line\",\"data-line-number\":\"87\",children:[\"      \",(0,a.jsx)(e.span,{style:{color:\"var(--base08)\"},children:\"Value\"}),\": \",(0,a.jsx)(e.span,{style:{color:\"var(--base0A)\"},children:\"!GetAtt\"}),\" \",(0,a.jsx)(e.span,{style:{color:\"var(--base0B)\"},children:\"MediaCloudFrontDistribution.Id\"}),`\n`]}),(0,a.jsxs)(e.span,{className:\"codeblock-line\",\"data-line-number\":\"88\",children:[\"      \",(0,a.jsx)(e.span,{style:{color:\"var(--base08)\"},children:\"Export\"}),\":\",`\n`]}),(0,a.jsxs)(e.span,{className:\"codeblock-line\",\"data-line-number\":\"89\",children:[\"        \",(0,a.jsx)(e.span,{style:{color:\"var(--base08)\"},children:\"Name\"}),\": \",(0,a.jsx)(e.span,{style:{color:\"var(--base0B)\"},children:\"DistributionId\"}),`\n`]}),(0,a.jsxs)(e.span,{className:\"codeblock-line\",\"data-line-number\":\"90\",children:[\"    \",(0,a.jsx)(e.span,{style:{color:\"var(--base08)\"},children:\"DomainName\"}),\":\",`\n`]}),(0,a.jsxs)(e.span,{className:\"codeblock-line\",\"data-line-number\":\"91\",children:[\"      \",(0,a.jsx)(e.span,{style:{color:\"var(--base08)\"},children:\"Value\"}),\": \",(0,a.jsx)(e.span,{style:{color:\"var(--base0A)\"},children:\"!GetAtt\"}),\" \",(0,a.jsx)(e.span,{style:{color:\"var(--base0B)\"},children:\"MediaCloudFrontDistribution.DomainName\"}),`\n`]}),(0,a.jsxs)(e.span,{className:\"codeblock-line\",\"data-line-number\":\"92\",children:[\"      \",(0,a.jsx)(e.span,{style:{color:\"var(--base08)\"},children:\"Export\"}),\":\",`\n`]}),(0,a.jsxs)(e.span,{className:\"codeblock-line\",\"data-line-number\":\"93\",children:[\"        \",(0,a.jsx)(e.span,{style:{color:\"var(--base08)\"},children:\"Name\"}),\": \",(0,a.jsx)(e.span,{style:{color:\"var(--base0B)\"},children:\"DomainName\"}),`\n`]}),(0,a.jsx)(e.span,{className:\"codeblock-line\",\"data-line-number\":\"94\",children:`\n`}),(0,a.jsxs)(e.span,{className:\"codeblock-line\",\"data-line-number\":\"95\",children:[(0,a.jsx)(e.span,{style:{color:\"var(--base08)\"},children:\"functions\"}),\":\",`\n`]}),(0,a.jsxs)(e.span,{className:\"codeblock-line\",\"data-line-number\":\"96\",children:[\"  \",(0,a.jsx)(e.span,{style:{color:\"var(--base08)\"},children:\"cloudFrontRouter\"}),\":\",`\n`]}),(0,a.jsxs)(e.span,{className:\"codeblock-line\",\"data-line-number\":\"97\",children:[\"    \",(0,a.jsx)(e.span,{style:{color:\"var(--base03)\"},children:\"# Path to the actual function\"}),`\n`]}),(0,a.jsxs)(e.span,{className:\"codeblock-line\",\"data-line-number\":\"98\",children:[\"    \",(0,a.jsx)(e.span,{style:{color:\"var(--base08)\"},children:\"handler\"}),\": \",(0,a.jsx)(e.span,{style:{color:\"var(--base0B)\"},children:\"src/index.handler\"}),`\n`]}),(0,a.jsxs)(e.span,{className:\"codeblock-line\",\"data-line-number\":\"99\",children:[\"    \",(0,a.jsx)(e.span,{style:{color:\"var(--base08)\"},children:\"lambdaAtEdge\"}),\":\",`\n`]}),(0,a.jsxs)(e.span,{className:\"codeblock-line\",\"data-line-number\":\"100\",children:[\"      \",(0,a.jsx)(e.span,{style:{color:\"var(--base08)\"},children:\"distribution\"}),\": \",(0,a.jsx)(e.span,{style:{color:\"var(--base0B)\"},children:\"MediaCloudFrontDistribution\"}),`\n`]}),(0,a.jsxs)(e.span,{className:\"codeblock-line\",\"data-line-number\":\"101\",children:[\"      \",(0,a.jsx)(e.span,{style:{color:\"var(--base08)\"},children:\"eventType\"}),\": \",'\"',(0,a.jsx)(e.span,{style:{color:\"var(--base0B)\"},children:\"origin-request\"}),'\"',`\n`]})]})}),`\n`,(0,a.jsxs)(e.h3,{id:\"step-3-deploy-the-stack\",children:[(0,a.jsx)(e.a,{\"aria-hidden\":\"true\",tabIndex:\"-1\",href:\"#step-3-deploy-the-stack\",children:(0,a.jsx)(e.span,{className:\"icon icon-link\"})}),\"Step 3: Deploy the stack\"]}),`\n`,(0,a.jsxs)(e.p,{children:[\"Now that we have the \",(0,a.jsx)(e.code,{children:\"serverless.yml\"}),\" file ready, we can deploy the stack using the Serverless Framework:\"]}),`\n`,(0,a.jsx)(e.pre,{\"data-line-numbers\":\"true\",tabIndex:\"0\",\"data-lang\":\"bash\",style:{color:\"var(--base05)\",backgroundColor:\"var(--base00)\"},children:(0,a.jsx)(e.code,{children:(0,a.jsxs)(e.span,{className:\"codeblock-line\",\"data-line-number\":\"1\",children:[(0,a.jsx)(e.span,{style:{color:\"var(--base0A)\"},children:\"serverless\"}),\" \",(0,a.jsx)(e.span,{style:{color:\"var(--base0B)\"},children:\"deploy\"}),`\n`]})})}),`\n`,(0,a.jsxs)(e.p,{children:[\"And that's it! You should now have a CloudFront distribution that routes the requests to the desired Origin endpoint based on the URL scheme you defined back in \",(0,a.jsx)(e.a,{href:\"#step-1-create-the-lambdaedge-function\",children:\"Step #1\"}),\".\"]}),`\n`,(0,a.jsxs)(l,{summary:\"What about the costs?\",children:[(0,a.jsxs)(e.p,{children:[\"The costs of this solution are minimal, since you're only charged for the requests made to the Lambda function to perform the routing, and the CloudFront distribution itself. You can check the pricing for Lambda@Edge \",(0,a.jsx)(e.a,{href:\"https://aws.amazon.com/lambda/pricing/\",children:\"here\"}),\" and for CloudFront \",(0,a.jsx)(e.a,{href:\"https://aws.amazon.com/cloudfront/pricing/\",children:\"here\"}),\".\"]}),(0,a.jsxs)(e.p,{children:[\"But for our specific use case, the costs are defined in the article \",(0,a.jsx)(e.a,{href:\"https://aws.amazon.com/blogs/media/creating-dynamic-mediapackage-origin-mappings-using-amazon-cloudfront-and-aws-lambdaedge/\",children:\"here\"}),\"; quoting from it:\"]}),(0,a.jsxs)(\"blockquote\",{children:[(0,a.jsx)(e.p,{children:\"The pricing of CloudFront is described here: https://aws.amazon.com/cloudfront/pricing/. Note, both Data Transfer Out costs and Origin Shield Requests costs apply in this example. Origin Shield has been enabled to help reduce the number of origin requests (and so reducing the number of Lambda@Edge invocations).\"}),(0,a.jsx)(e.p,{children:\"Lambda@Edge has two pricing components:\"}),(0,a.jsx)(e.p,{children:`Request pricing is $0.60 per 1 million requests ($0.0000006 per request).\nDuration is priced at $0.00005001 for every GB-second used, metered in 1ms granularity. As the function above is sized at 128mb and executes in 2ms on average, the price per invocation is roughly $0.0000000125025 per origin request.\nTaking the total of requests + duration gives each Lambda@Edge invocation (for each origin request) a total cost of $0.0000006125025.`}),(0,a.jsx)(e.p,{children:\"Calculating the number of origin requests is based on number of factors. Origin requests will be made for each media segment and manifest updates when there is a cache miss. As such, the adaptive bitrate segment length of the media affects how often origin requests are made. It is worthwhile to measure the number of origin requests on your origin to calculate the cost of the solution.\"}),(0,a.jsx)(e.p,{children:\"As an example, in an environment where 100 requests per second are made to the origin, the total Lambda@Edge cost for a 3 hour event would be:\"}),(0,a.jsx)(e.p,{children:\"100 (requests per second) x 3600 (seconds in 1 hour) x 3 (hours) x $0.0000006125025 (cost per origin request) = $0.66\"})]})]})]})}function h(n={}){let{wrapper:e}=n.components||{};return e?(0,a.jsx)(e,{...n,children:(0,a.jsx)(d,{...n})}):d(n)}function w(n,e){throw new Error(\"Expected \"+(e?\"component\":\"object\")+\" `\"+n+\"` to be defined: you likely forgot to import, pass, or provide it.\")}return f(C);})();\n;return Component;","frontmatter":{"title":"Dynamic Origin for CloudFront with Lambda@Edge","description":"Support infinite* origins for your CloudFront distribution with Lambda@Edge.","tags":["AWS","CloudFront","Serverless"],"date":"10/10/2024","imageSrc":"/build/journal/cloudfront-lambda-edge/image.jpg","imageAlt":"A person in a warehouse using a forklift.","imageCredit":"ELEVATE","imageBlurUri":"data:image/jpeg;base64,/9j/2wBDAAYEBQYFBAYGBQYHBwYIChAKCgkJChQODwwQFxQYGBcUFhYaHSUfGhsjHBYWICwgIyYnKSopGR8tMC0oMCUoKSj/2wBDAQcHBwoIChMKChMoGhYaKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCj/wAARCAAHAAoDASIAAhEBAxEB/8QAFgABAQEAAAAAAAAAAAAAAAAAAAYH/8QAIRAAAgICAQQDAAAAAAAAAAAAAQIDBAAFEQYSITEyQUL/xAAVAQEBAAAAAAAAAAAAAAAAAAABBP/EABoRAAIDAQEAAAAAAAAAAAAAAAECABGxUWH/2gAMAwEAAhEDEQA/ALLfbKjY3VrVS066Vg1qRZZ4AwR+PlwCe7liv58dozGbOj6MlsyySbnqtXdyzCOKAKCT9efWMZMq0zD07F2oCuDJ/9k="},"errors":[],"matter":{"content":"\n> If you're in a hurry, you can jump straight to the [solution](#the-solution).\n\nRecently I had to implement a solution that's now part of the live streaming capabilities of [FanFest v3](https://app.fanfest.io/psg) and it involved dealing with CloudFront and it ended up being a great opportunity to learn more about its inner-working.\n\nThe setup for this task is simple: for every live show we do, we have to create 2 AWS MediaLive channels (one for mobile and another one for desktop), and each channel has its own HLS endpoint. This was being distributed via S3 in its own bucket containing the segments and manifest files - since the S3 bucket is a single origin for the CloudFront distribution, that was easy-peasy.\n\nBut then we noticed the latency of the channels was too high for the experiences we wanted to deliver to our users, so we decided to use MediaPackage to fix that. This creates a problem: each MediaPackage channel has its own endpoint which requires its individual origin in CloudFront.\n\nDigging up the AWS documentation, I found out that CloudFront only supports up-to 100 origins per distribution, which is a problem for us since we don't want to constrain ourselves to a fixed number of live shows. So I had to come up with a solution that would allow us to support inifinite (rather dynamic, we didn't really have infinite money ) origins for our CloudFront distribution.\n\nFortunately and thanks to all the great work from AWS team, I found this weirdly specific article on the subject: [Creating dynamic MediaPackage origin mappings using Amazon CloudFront and AWS Lambda@Edge](https://aws.amazon.com/blogs/media/creating-dynamic-mediapackage-origin-mappings-using-amazon-cloudfront-and-aws-lambdaedge/) so the implementation was pretty straightforward.\n\n<Details summary=\"You're telling me you'll have 100 shows!? YAGNI\">\nWell, not really. But think about trying to come back to this later on and realising you have to refactor everything because you didn't think about it before. Since we're just getting started, it's better to think about it now and save ourselves some headaches later on.\n</Details>\n\n## The Solution\n\nThe solution is to use Lambda@Edge to route the requests to the desired Origin on demand.\n\n> Since I find myself very comfortable using the Serverless Framework, I'll be using it in this guide to deploy the routing function. But notice that you can use similar tools or AWS' console to deploy the Lambda.\n\n### Step 1: Create the Lambda@Edge function\n\nFor this, you should have defined the URL scheme you'll use to route the requests. For our case, we decided to use a scheme similar to the following:\n\n```javascript\n`https://${distribution}.cloudfront.net/${show_id}/${format}/${filename}`\n```\n\nWhere `distribution` is the CloudFront distribution ID, `show_id` is the ID of the show, `format` is the format of the stream (e.g. `mobile`, `desktop`) and `filename` is the name of the file requested.\n\nThen we would route the request to the corresponding MediaPackage endpoint.\n\n```javascript\n`https://${show_id}.mediapackagev2.eu-west-1.amazonaws.com/out/v1/${show_id}-group/${format}/${format}/${filename}`\n```\n\n> Note that the params that you'll use to route the request can be anything you want, as long as you can parse them in the Lambda function and route the request accordingly.\n\nNow that we have the URL scheme defined, we can create the Lambda function that will route the requests:\n\n```javascript\nfunction parseRequestParams(requestUrl) {\n  // Target URI: /${show_id}/${format}/${filename}\n  const regex = /\\/([^\\/]+)\\/([^\\/]+)\\/([^\\/?]+)?.*/;\n  const match = requestUrl.match(regex);\n\n  if (!match) {\n    throw new Error(\"Invalid request url \" + requestUrl);\n  }\n\n  const [, showId, format, filename] = match;\n\n  // TODO: validate params...\n\n  return {\n    showId,\n    format,\n    filename,\n  };\n}\n\nasync function handler (event) {\n  const request = event.Records[0].cf.request;\n  const uri = request.uri;\n\n  try {\n    const { showId, format, filename } =\n      parseRequestParams(uri);\n\n    const domainName = `${showId}.mediapackagev2.eu-west-1.amazonaws.com`;\n    const path = `/out/v1/${showId}-group/${format}/${format}/${filename}`;\n\n    // Update the URL\n    request.origin!.custom!.domainName = domainName;\n    request.uri = path;\n    request.headers[\"host\"] = [{ key: \"Host\", value: domainName }];\n    console.log(request);\n  } catch (error) {\n    // If something goes wrong, keep the original request and do no routing\n    // TODO: redirect to a custom not found page\n    console.error(error);\n  }\n\n  return request;\n};\n\nmodule.exports = { handler };\n```\n\n<Details summary=\"Using TypeScript? Here's the type definitions for the handler function\">\nJust import the types `CloudFrontRequestEvent`,  `CloudFrontRequestHandler` and `CloudFrontRequestResult` from `@types/aws-lambda` package.\n\n```typescript\nimport type {\n  CloudFrontRequestEvent,\n  CloudFrontRequestHandler,\n  CloudFrontRequestResult,\n} from \"aws-lambda\";\n\n// Match the following signature\ntype Handler = (event: CloudFrontRequestEvent) => Promise<CloudFrontRequestResult>\n```\n</Details>\n\n### Step 2: Deploy the Lambda function\n\nNow that we have the Lambda function ready, we can deploy it using the Serverless Framework. In my case, I'm deploying the CloudFront distribution and the Lambda function in the same stack, here's the `serverless.yml` file:\n\n```yaml\nservice: cloudfront-router\nconfigValidationMode: error\nframeworkVersion: \"3\"\n\nplugins:\n  # Using this plugin for a simpler CF configuration than the native \n  # offering from the Serverless Framework\n  - \"@silvermine/serverless-plugin-cloudfront-lambda-edge\"\n\nprovider:\n  name: aws\n  # Lambda@Edge requires the function to be deployed in us-east-1 (Virginia)!\n  region: us-east-1\n  runtime: nodejs18.x\n\n# Remember to enter the pattern (path) to the files you'll use for the function\npackage:\n  pattern:\n    src/**/*\n\nresources:\n  Resources:\n    MediaCloudFrontDistribution:\n      Type: AWS::CloudFront::Distribution\n      Properties:\n        DistributionConfig:\n          Enabled: true\n          DefaultCacheBehavior:\n            TargetOriginId: DefaultOrigin\n            ViewerProtocolPolicy: redirect-to-https\n            AllowedMethods:\n              - GET\n              - HEAD\n            CachedMethods:\n              - GET\n              - HEAD\n            ForwardedValues:\n              QueryString: true\n              Cookies:\n                Forward: none\n            ResponseHeadersPolicyId: !Ref MediaCFResponseHeadersPolicy\n            Compress: true\n          ViewerCertificate:\n            CloudFrontDefaultCertificate: true\n          HttpVersion: http2\n          PriceClass: PriceClass_100\n          Origins:\n            - Id: \"DefaultOrigin\"\n              # This domain needs to match the domain you use in your\n              # Lambda code.\n              # --------------\n              # Also - This will be the default request origin if your lambda\n              # doesn't re-route the calls using whatever URL scheme you defined\n              # so make sure this points to somewhere valid inside the domain\n              # you'll redirect to in the Lambda code.\n\n              DomainName: mediapackagev2.eu-west-1.amazonaws.com\n              CustomOriginConfig:\n                HTTPPort: 80\n                HTTPSPort: 443\n                OriginProtocolPolicy: \"match-viewer\"\n                OriginReadTimeout: 30\n                OriginKeepaliveTimeout: 5\n              ConnectionAttempts: 3\n              ConnectionTimeout: 10\n\n    MediaCFResponseHeadersPolicy:\n      Type: AWS::CloudFront::ResponseHeadersPolicy\n      Properties:\n        ResponseHeadersPolicyConfig:\n          Name: \"allow-website\"\n          Comment: \"Allow main website\"\n          CorsConfig:\n            AccessControlAllowCredentials: false\n            AccessControlAllowMethods:\n              Items:\n                - \"GET\"\n            AccessControlAllowOrigins:\n              Items:\n                # Remember to use your actual domain here\n                - \"example.com\"\n            OriginOverride: true\n  # These outputs are more for reference, they'll help you debug\n  # your CF distribution if necessary\n  Outputs:\n    DistributionId:\n      Value: !GetAtt MediaCloudFrontDistribution.Id\n      Export:\n        Name: DistributionId\n    DomainName:\n      Value: !GetAtt MediaCloudFrontDistribution.DomainName\n      Export:\n        Name: DomainName\n\nfunctions:\n  cloudFrontRouter:\n    # Path to the actual function\n    handler: src/index.handler\n    lambdaAtEdge:\n      distribution: MediaCloudFrontDistribution\n      eventType: \"origin-request\"\n```\n\n### Step 3: Deploy the stack\n\nNow that we have the `serverless.yml` file ready, we can deploy the stack using the Serverless Framework:\n\n```bash\nserverless deploy\n```\n\nAnd that's it! You should now have a CloudFront distribution that routes the requests to the desired Origin endpoint based on the URL scheme you defined back in [Step #1](#step-1-create-the-lambdaedge-function).\n\n<Details summary=\"What about the costs?\">\n  The costs of this solution are minimal, since you're only charged for the requests made to the Lambda function to perform the routing, and the CloudFront distribution itself. You can check the pricing for Lambda@Edge [here](https://aws.amazon.com/lambda/pricing/) and for CloudFront [here](https://aws.amazon.com/cloudfront/pricing/).\n\n  But for our specific use case, the costs are defined in the article [here](https://aws.amazon.com/blogs/media/creating-dynamic-mediapackage-origin-mappings-using-amazon-cloudfront-and-aws-lambdaedge/); quoting from it:\n\n  <blockquote>\n    The pricing of CloudFront is described here: https://aws.amazon.com/cloudfront/pricing/. Note, both Data Transfer Out costs and Origin Shield Requests costs apply in this example. Origin Shield has been enabled to help reduce the number of origin requests (and so reducing the number of Lambda@Edge invocations).\n\n    Lambda@Edge has two pricing components:\n\n    Request pricing is $0.60 per 1 million requests ($0.0000006 per request).\n    Duration is priced at $0.00005001 for every GB-second used, metered in 1ms granularity. As the function above is sized at 128mb and executes in 2ms on average, the price per invocation is roughly $0.0000000125025 per origin request.\n    Taking the total of requests + duration gives each Lambda@Edge invocation (for each origin request) a total cost of $0.0000006125025.\n\n    Calculating the number of origin requests is based on number of factors. Origin requests will be made for each media segment and manifest updates when there is a cache miss. As such, the adaptive bitrate segment length of the media affects how often origin requests are made. It is worthwhile to measure the number of origin requests on your origin to calculate the cost of the solution.\n\n    As an example, in an environment where 100 requests per second are made to the origin, the total Lambda@Edge cost for a 3 hour event would be:\n\n    100 (requests per second) x 3600 (seconds in 1 hour) x 3 (hours) x $0.0000006125025 (cost per origin request) = $0.66\n  </blockquote>\n</Details>\n","data":{"title":"Dynamic Origin for CloudFront with Lambda@Edge","description":"Support infinite* origins for your CloudFront distribution with Lambda@Edge.","tags":["AWS","CloudFront","Serverless"],"date":"10/10/2024","imageSrc":"/build/journal/cloudfront-lambda-edge/image.jpg","imageAlt":"A person in a warehouse using a forklift.","imageCredit":"ELEVATE","imageBlurUri":"data:image/jpeg;base64,/9j/2wBDAAYEBQYFBAYGBQYHBwYIChAKCgkJChQODwwQFxQYGBcUFhYaHSUfGhsjHBYWICwgIyYnKSopGR8tMC0oMCUoKSj/2wBDAQcHBwoIChMKChMoGhYaKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCj/wAARCAAHAAoDASIAAhEBAxEB/8QAFgABAQEAAAAAAAAAAAAAAAAAAAYH/8QAIRAAAgICAQQDAAAAAAAAAAAAAQIDBAAFEQYSITEyQUL/xAAVAQEBAAAAAAAAAAAAAAAAAAABBP/EABoRAAIDAQEAAAAAAAAAAAAAAAECABGxUWH/2gAMAwEAAhEDEQA/ALLfbKjY3VrVS066Vg1qRZZ4AwR+PlwCe7liv58dozGbOj6MlsyySbnqtXdyzCOKAKCT9efWMZMq0zD07F2oCuDJ/9k="},"isEmpty":false,"excerpt":""}}